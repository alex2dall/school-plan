<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>×ª×¨×©×™× ×’×× ×˜ ×—×“×©× ×•×ª ×¤×“×’×•×’×™×ª ×¢×œ×™ ×“×œ××©×” â€¢ ×‘×™×ª ×”×¡×¤×¨ ×”×˜×›× ×•×œ×•×’×™ ×œ×§×™×”</title>

<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<!-- XLSX export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --blue:#0b63b6;
    --gray:#f6f7f9;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --chip:#eef2ff;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:#fff;color:var(--text);margin:0}

  /* ×›× ×™×¡×” */
  #loginOverlay{position:fixed;inset:0;background:linear-gradient(120deg,#0b63b6 0,#1f3a5f 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
  #loginCard{background:#fff;border-radius:14px;padding:22px 20px;width:94%;max-width:360px;box-shadow:0 10px 30px #0004}
  #loginCard h2{color:var(--blue);margin:0 0 10px}
  #loginCard input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0 12px}
  #loginCard button{width:100%;padding:10px;border:none;border-radius:10px;background:var(--blue);color:#fff;cursor:pointer}
  #loginMsg{color:#b91c1c;height:18px;font-size:13px}

  header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{margin:0;color:var(--blue);font-size:22px}
  .btn{border:1px solid var(--border);background:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn.danger{background:#e11d48;border-color:#e11d48;color:#fff}
  .btn.success{background:#16a34a;border-color:#16a34a;color:#fff}
  .btn.icon{display:inline-flex;gap:6px;align-items:center}

  .filters{display:flex;flex-wrap:wrap;gap:10px;padding:10px 20px;border-bottom:1px solid var(--border);background:#fafafa}
  .filters label{font-size:13px;color:var(--muted)}
  .filters input[type="date"], .filters select, .filters input[type="text"]{padding:6px 8px;border:1px solid var(--border);border-radius:6px}

  .legend{display:flex;gap:8px;align-items:center}
  .sw{width:14px;height:14px;border-radius:4px;border:1px solid #0003;display:inline-block;margin-left:6px}

  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{padding:6px 10px;border-radius:999px;font-size:13px;background:var(--chip);cursor:pointer;border:1px solid var(--border)}
  .chip.active{outline:2px solid var(--blue)}

  #ganttWrap{border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:#fff}
  #gantt{min-height:440px;padding:12px 0}

  section{padding:14px 20px}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid var(--border);padding:8px;text-align:center}
  th{background:#f0f2f6}
  .actions{display:flex;gap:6px;justify-content:center}
  select, input[type="number"], input[type="text"]{padding:6px;border:1px solid var(--border);border-radius:6px}

  /* ××•×“××œ ×¢×¨×™×›×” */
  dialog{border:none;border-radius:12px;max-width:560px;width:92%}
  dialog::backdrop{background:rgb(0 0 0 / .45)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .form-grid label{font-size:13px;color:var(--muted)}
  .form-grid input,.form-grid select, .form-grid textarea{width:100%;padding:7px;border:1px solid var(--border);border-radius:8px}
  .row{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

  /* ×¦×‘×¢×™× ×œ×¤×™ ×ª×—×•× */
  .c-×¤×“×’×•×’×™{background:#3b82f6}
  .c-×œ×™××•×“×™{background:#84cc16}
  .c-×˜×›× ×•×œ×•×’×™{background:#06b6d4}
  .c-×§×”×™×œ×ª×™{background:#a855f7}
  .c-×—×‘×¨×ª×™{background:#ef4444}
  .c-××•×¡×“×™{background:#f59e0b}

  /* ×”×“×¤×¡×” */
  #printBar{padding:10px 20px;border-bottom:1px solid var(--border);background:#fafafa}
  @media print{
    header,.filters,#printBar{display:none !important}
    body{background:#fff}
    table{page-break-inside:avoid}
  }
</style>
</head>
<body>

<!-- ×”×ª×—×‘×¨×•×ª -->
<div id="loginOverlay">
  <div id="loginCard">
    <h2>×›× ×™×¡×”</h2>
    <p style="margin:0 0 10px">×”×–×Ÿ ×¤×¨×˜×™ ×’×™×©×”</p>
    <input id="u" placeholder="×©× ××©×ª××©" autocomplete="username">
    <input id="p" placeholder="×¡×™×¡××”" type="password" autocomplete="current-password">
    <div id="loginMsg"></div>
    <button id="loginBtn">×”×ª×—×‘×¨</button>
  </div>
</div>

<header>
  <h1>×ª×¨×©×™× ×’×× ×˜ â€¢ ×‘×™×ª ×”×¡×¤×¨ ×”×˜×›× ×•×œ×•×’×™ ×œ×§×™×”</h1>
  <div id="toolbar">
    <button class="btn primary icon" id="addTaskBtn">â• ×”×•×¡×£ ×¤×¢×™×œ×•×ª</button>
    <button class="btn icon" id="addKpiBtn">â• ×”×•×¡×£ KPI</button>
    <button class="btn" id="viewDay">×™×•×</button>
    <button class="btn" id="viewWeek">×©×‘×•×¢</button>
    <button class="btn" id="viewMonth">×—×•×“×©</button>
    <button class="btn success" id="exportXlsxBtn">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>
    <button class="btn" id="exportJsonBtn">ğŸ“¤ ×™×™×¦×•× JSON</button>
    <label class="btn">
      ğŸ“¥ ×™×™×‘×•× JSON <input id="importJson" type="file" accept="application/json" style="display:none">
    </label>
    <button class="btn danger" id="resetBtn">â™»ï¸ ××™×¤×•×¡</button>
  </div>
</header>

<!-- ××¡× × ×™× -->
<div class="filters" id="filters">
  <div class="legend" style="flex:1 1 100%">
    <span class="sw c-×¤×“×’×•×’×™"></span>×¤×“×’×•×’×™
    <span class="sw c-×œ×™××•×“×™"></span>×œ×™××•×“×™
    <span class="sw c-×˜×›× ×•×œ×•×’×™"></span>×˜×›× ×•×œ×•×’×™
    <span class="sw c-×§×”×™×œ×ª×™"></span>×§×”×™×œ×ª×™
    <span class="sw c-×—×‘×¨×ª×™"></span>×—×‘×¨×ª×™ ×¨×’×©×™
    <span class="sw c-××•×¡×“×™"></span>××•×¡×“×™
  </div>
  <div class="chips" id="domainChips" style="flex:1 1 100%"></div>

  <label>×¡×˜×˜×•×¡:
    <select id="statusFilter">
      <option value="all">×”×›×œ</option>
      <option>×‘×ª×›× ×•×Ÿ</option><option>×‘×ª×”×œ×™×š</option><option>×”×•×©×œ×</option><option>× ×“×—×”</option>
    </select>
  </label>
  <label>××ª××¨×™×š: <input type="date" id="fromDate"></label>
  <label>×¢×“ ×ª××¨×™×š: <input type="date" id="toDate"></label>
  <label>×—×™×¤×•×©: <input type="text" id="searchTxt" placeholder="×—×¤×© ×¤×¢×•×œ×”..."></label>
  <button class="btn" id="clearFilters">× ×™×§×•×™</button>
</div>

<!-- ×’×× ×˜ -->
<div id="ganttWrap"><div id="gantt"></div></div>

<!-- ×¤×§×“ ×”×“×¤×¡×” ××•×˜×‘×¢ -->
<div id="printBar">
  <label><input type="checkbox" id="printGantt" checked> ×ª×¨×©×™× ×’×× ×˜</label>
  <label><input type="checkbox" id="printTasks" checked> ×˜×‘×œ×ª ××©×™××•×ª</label>
  <label><input type="checkbox" id="printKpi" checked> ×˜×‘×œ×ª KPI</label>
  <button class="btn primary" id="printBtn">ğŸ–¨ï¸ ×”×“×¤×¡</button>
</div>

<!-- ××©×™××•×ª -->
<section>
  <h2 style="color:var(--blue);margin:6px 0 10px">×˜×‘×œ×ª ××©×™××•×ª</h2>
  <table id="taskTable">
    <thead>
      <tr>
        <th>#</th><th>×ª×—×•×</th><th>×¤×¢×•×œ×”</th><th>×”×ª×—×œ×”</th><th>×¡×™×•×</th><th>×¡×˜×˜×•×¡</th><th>×ª×œ×•×ª</th><th>×¤×¢×•×œ×•×ª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- KPI -->
<section>
  <h2 style="color:var(--blue);margin:6px 0 10px">×˜×‘×œ×ª KPI</h2>
  <table id="kpiTable">
    <thead>
      <tr>
        <th>#</th><th>×ª×—×•×</th><th>××“×“ ×‘×™×¦×•×¢</th><th>×™×¢×“ ×©× ×ª×™</th><th>×›×œ×™ ××“×™×“×”</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- ××•×“××œ ××©×™××” â€“ ×¢×¨×™×›×” ××œ××” -->
<dialog id="taskDlg">
  <form method="dialog">
    <h3 style="margin:0 0 10px;color:var(--blue)">×¤×¢×™×œ×•×ª</h3>
    <div class="form-grid">
      <div><label>×©× ×”×¤×¢×™×œ×•×ª</label><input id="tName"></div>
      <div><label>×ª×—×•×</label>
        <select id="tDomain">
          <option>×¤×“×’×•×’×™</option><option>×œ×™××•×“×™</option><option>×˜×›× ×•×œ×•×’×™</option>
          <option>×§×”×™×œ×ª×™</option><option>×—×‘×¨×ª×™</option><option>××•×¡×“×™</option>
        </select>
      </div>
      <div><label>×ª××¨×™×š ×”×ª×—×œ×”</label><input type="date" id="tStart"></div>
      <div><label>×ª××¨×™×š ×¡×™×•×</label><input type="date" id="tEnd"></div>
      <div><label>×¡×˜×˜×•×¡</label>
        <select id="tStatus"><option>×‘×ª×›× ×•×Ÿ</option><option>×‘×ª×”×œ×™×š</option><option>×”×•×©×œ×</option><option>× ×“×—×”</option></select>
      </div>
      <div><label>Progress %</label><input type="number" id="tProg" min="0" max="100" value="0"></div>
      <div style="grid-column:1/3"><label>×ª×œ×•×ª (××–×”×™× ××•×¤×¨×“×™× ×‘×¤×¡×™×§)</label><input id="tDep" placeholder="×œ××©×œ: 1,3"></div>
      <div><label>××–×”×”</label><input id="tId" disabled></div>
      <div><label>×”×¢×¨×•×ª</label><input id="tNote" placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª"></div>
    </div>
    <div class="row">
      <button class="btn danger" type="button" id="tDelete">××—×™×§×”</button>
      <div style="flex:1"></div>
      <button class="btn" type="button" onclick="byId('taskDlg').close()">×‘×™×˜×•×œ</button>
      <button class="btn primary" id="tSave">×©××™×¨×”</button>
    </div>
  </form>
</dialog>

<!-- ××•×“××œ KPI â€“ ×¢×¨×™×›×” ××œ××” -->
<dialog id="kpiDlg">
  <form method="dialog">
    <h3 style="margin:0 0 10px;color:var(--blue)">KPI</h3>
    <div class="form-grid">
      <div><label>×ª×—×•×</label>
        <select id="kDomain">
          <option>×œ×™××•×“×™</option><option>×˜×›× ×•×œ×•×’×™</option><option>×—×‘×¨×ª×™ ×¨×’×©×™</option>
          <option>×§×”×™×œ×ª×™</option><option>××•×¡×“×™</option><option>×¤×“×’×•×’×™</option>
        </select>
      </div>
      <div><label>×¡×˜×˜×•×¡</label>
        <select id="kStatus"><option>×‘×ª×›× ×•×Ÿ</option><option>×‘×ª×”×œ×™×š</option><option>×”×•×©×œ×</option></select>
      </div>
      <div style="grid-column:1/3"><label>××“×“ ×‘×™×¦×•×¢</label><input id="kMetric"></div>
      <div><label>×™×¢×“ ×©× ×ª×™</label><input id="kTarget"></div>
      <div><label>×›×œ×™ ××“×™×“×”</label><input id="kTool"></div>
      <div><label>××–×”×”</label><input id="kId" disabled></div>
      <div style="grid-column:1/3"><label>×”×¢×¨×•×ª</label><input id="kNote" placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª"></div>
    </div>
    <div class="row">
      <button class="btn danger" type="button" id="kDelete">××—×™×§×”</button>
      <div style="flex:1"></div>
      <button class="btn" type="button" onclick="byId('kpiDlg').close()">×‘×™×˜×•×œ</button>
      <button class="btn primary" id="kSave">×©××™×¨×”</button>
    </div>
  </form>
</dialog>

<script>
/* ====== ×˜×¢×™× ×ª Google Charts ====== */
google.charts.load('current', {packages:['timeline']});

/* ====== ×§×‘×•×¢×™× ====== */
const YEAR_START = new Date('2025-09-01');
const YEAR_END   = new Date('2026-08-31');
const DOMAINS = ["×¤×“×’×•×’×™","×œ×™××•×“×™","×˜×›× ×•×œ×•×’×™","×§×”×™×œ×ª×™","×—×‘×¨×ª×™","××•×¡×“×™"];
const COLORS = { "×¤×“×’×•×’×™":"#3b82f6","×œ×™××•×“×™":"#84cc16","×˜×›× ×•×œ×•×’×™":"#06b6d4","×§×”×™×œ×ª×™":"#a855f7","×—×‘×¨×ª×™":"#ef4444","××•×¡×“×™":"#f59e0b" };

const byId = (id)=>document.getElementById(id);
const fmt = (d)=>new Date(d).toISOString().slice(0,10);
function withinSchoolYear(date){ const d=new Date(date); return d>=YEAR_START && d<=YEAR_END; }
function clampToSchoolYear(date){ const d=new Date(date); if(d<YEAR_START) return fmt(YEAR_START); if(d>YEAR_END) return fmt(YEAR_END); return fmt(d); }
function newId(){ return Date.now().toString(36); }

/* ====== × ×ª×•× ×™ ×‘×¨×™×¨×ª ××—×“×œ â€“ 20 ×¤×¢×™×œ×•×™×•×ª ××¤×•×¨×˜×•×ª ====== */
const defaultTasks = [
  {id:"1",  domain:"×¤×“×’×•×’×™",  action:"×¡×“× ×ª ×¤×ª×™×—×” ×œ×¦×•×•×ª ×•×”×¦×’×ª ×—×–×•×Ÿ",  start:"2025-09-05", end:"2025-09-10", status:"×”×•×©×œ×",   dependencies:"", progress:100, note:""},
  {id:"2",  domain:"×œ×™××•×“×™",   action:"××™×¤×•×™ ×ª×œ××™×“×™ ×™\"× ×—×“×©×™× ×•×”×¢×¨×›×ª ×¤×¢×¨×™×", start:"2025-09-15", end:"2025-10-10", status:"×‘×ª×”×œ×™×š", dependencies:"", progress:70, note:""},
  {id:"3",  domain:"×˜×›× ×•×œ×•×’×™", action:"×™×™×©×•× ×™×—×™×“×•×ª PBL ×¨××©×•× ×•×ª",   start:"2025-10-15", end:"2025-11-20", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"2", progress:30, note:""},
  {id:"4",  domain:"×§×”×™×œ×ª×™",   action:"×”×©×§×ª ×ª×—× ×ª ×¨×“×™×• ×‘×™×ª ×¡×¤×¨×™×ª",    start:"2025-11-01", end:"2025-11-30", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:10, note:""},
  {id:"5",  domain:"××•×¡×“×™",    action:"×¡×™×›×•× ×¨×‘×¢×•×Ÿ ×¨××©×•×Ÿ",            start:"2025-12-01", end:"2025-12-10", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"6",  domain:"×—×‘×¨×ª×™",    action:"×¡×“× ××•×ª SEL ×•×›×™×©×•×¨×™ ×—×™×™×",      start:"2025-12-15", end:"2026-01-15", status:"×‘×ª×”×œ×™×š", dependencies:"", progress:25, note:""},
  {id:"7",  domain:"×¤×“×’×•×’×™",   action:"×¡×“× ×ª ×—×“×©× ×•×ª ×¤×“×’×•×’×™×ª",          start:"2026-01-20", end:"2026-01-25", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"5", progress:0,  note:""},
  {id:"8",  domain:"××•×¡×“×™",    action:"×”×¤×§×ª ×“×•×— ×‘×™× ×™×™× ×©× ×ª×™",         start:"2026-02-01", end:"2026-02-05", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"9",  domain:"×§×”×™×œ×ª×™",   action:"×™×•× ×§×”×™×œ×” ×•×—×©×™×¤×” ×œ×ª×¢×©×™×™×”",     start:"2026-02-15", end:"2026-02-20", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"3", progress:0,  note:""},
  {id:"10", domain:"×—×‘×¨×ª×™",    action:"×¤×¢×™×œ×•×™×•×ª ×”×¢×¦××” ×œ× ×•×¢×¨",         start:"2026-03-01", end:"2026-03-07", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"11", domain:"×˜×›× ×•×œ×•×’×™", action:"×ª×¢×¨×•×›×ª ×¤×¨×•×™×§×˜×™× ×‘×™×Ÿ-××’××ª×™×™×",  start:"2026-03-15", end:"2026-03-31", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"3", progress:0,  note:""},
  {id:"12", domain:"×§×”×™×œ×ª×™",   action:"×™×•× ×©×™× ××•×¡×“×™ ×œ×”×¦×’×ª ×ª×•×¦×¨×™×",    start:"2026-04-10", end:"2026-04-15", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"11",progress:0,  note:""},
  {id:"13", domain:"××•×¡×“×™",    action:"×”×¤×§×ª ×“×•×— ××¡×›× ×©× ×ª×™",           start:"2026-05-01", end:"2026-05-10", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"14", domain:"×—×‘×¨×ª×™",    action:"×™×•× ×’×™×‘×•×© ×©×›×‘×ª ×™\"×‘",          start:"2026-05-15", end:"2026-05-20", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"15", domain:"×¤×“×’×•×’×™",   action:"×”×“×¨×›×ª ××•×¨×™× ×‘-PBL",            start:"2026-05-25", end:"2026-05-30", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"3", progress:0,  note:""},
  {id:"16", domain:"×˜×›× ×•×œ×•×’×™", action:"×©×“×¨×•×’ ×¦×™×•×“ ××¢×‘×“×•×ª",             start:"2026-06-01", end:"2026-06-05", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"17", domain:"×§×”×™×œ×ª×™",   action:"×©×•×ª×¤×•×™×•×ª ×¢× ×¨×©×•×™×•×ª ×•×¢××•×ª×•×ª",   start:"2026-06-10", end:"2026-06-20", status:"×‘×ª×”×œ×™×š", dependencies:"", progress:50, note:""},
  {id:"18", domain:"××•×¡×“×™",    action:"×•×¢×™×“×ª ×—×™× ×•×š ×‘×™×ª ×¡×¤×¨×™×ª",        start:"2026-07-01", end:"2026-07-05", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"19", domain:"×—×‘×¨×ª×™",    action:"××—× ×” ×§×™×¥ ×‘×™×ª ×¡×¤×¨×™",             start:"2026-07-20", end:"2026-07-30", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"", progress:0,  note:""},
  {id:"20", domain:"×¤×“×’×•×’×™",   action:"×¡×“× ×ª ×¡×™×›×•× ×©× ×” ×œ×¦×•×•×ª",          start:"2026-08-10", end:"2026-08-15", status:"×‘×ª×›× ×•×Ÿ",  dependencies:"13",progress:0,  note:""}
];

/* ====== KPI ×‘×¨×™×¨×ª ××—×“×œ (15) ====== */
const defaultKpis = [
  {id:"k1",  domain:"×œ×™××•×“×™",     metric:"×©×™×¤×•×¨ ×¦×™×•× ×™×",               target:"×¢×œ×™×™×” 10%",             tool:"××‘×—× ×™×, ×“×•×—×•×ª",       status:"×‘×ª×”×œ×™×š", note:""},
  {id:"k2",  domain:"×œ×™××•×“×™",     metric:"× ×•×›×—×•×ª ×ª×œ××™×“×™×",             target:"â‰¥ 90%",                  tool:"××¢×¨×›×ª × ×•×›×—×•×ª",        status:"×‘×ª×”×œ×™×š", note:""},
  {id:"k3",  domain:"×˜×›× ×•×œ×•×’×™",   metric:"×”×©×ª×ª×¤×•×ª ×‘×¤×¨×•×™×§×˜×™×",          target:"â‰¥ 80%",                  tool:"×ª×™×§×™ ×¤×¨×•×™×§×˜×™×",       status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k4",  domain:"×¤×“×’×•×’×™",     metric:"×”×˜××¢×ª PBL ×‘××•×¨×•×ª/×™×",        target:"â‰¥ 70% ×¦×•×•×ª",            tool:"×ª×¦×¤×™×•×ª",              status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k5",  domain:"×§×”×™×œ×ª×™",     metric:"××™×¨×•×¢×™ ×§×”×™×œ×”/×ª×¢×©×™×™×”",        target:"×œ×¤×—×•×ª 3",                tool:"×“×•×—×•×ª ×—×©×™×¤×”",        status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k6",  domain:"×—×‘×¨×ª×™ ×¨×’×©×™", metric:"×ª×—×•×©×ª ×©×™×™×›×•×ª",               target:"â‰¥ 80%",                  tool:"×¡×§×¨×™ SEL",            status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k7",  domain:"××•×¡×“×™",      metric:"×“×•×—×•×ª ×‘×§×¨×”",                 target:"2 ×œ×©× ×”",                 tool:"××¢×¨×›×ª ×‘×§×¨×”",          status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k8",  domain:"×§×”×™×œ×ª×™",     metric:"××¤×’×©×™ ×‘×•×’×¨×™×",               target:"2 ×‘×©× ×”",                 tool:"×§×©×¨×™ ×§×”×™×œ×”",          status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k9",  domain:"×”×¢×©×¨×”",      metric:"××¡×¤×¨ ×—×•×’×™× ×¤×¢×™×œ×™×",          target:"â‰¥ 4",                    tool:"××¢×¨×›×ª ×—×•×’×™×",         status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k10", domain:"×”×¢×©×¨×”",      metric:"×”×©×ª×ª×¤×•×ª ×‘×—×•×’×™×",             target:"â‰¥ 60%",                  tool:"×“×•×—×•×ª × ×•×›×—×•×ª",        status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k11", domain:"××•×¡×“×™",      metric:"×‘×˜×™×—×•×ª ×¡×“× ××•×ª",              target:"100% ×ª×§×Ÿ",               tool:"×¨×©×•××•×ª ×‘×˜×™×—×•×ª",       status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k12", domain:"×œ×™××•×“×™",     metric:"××•×¨×™×™× ×•×ª ×“×™×’×™×˜×œ×™×ª",          target:"100%",                   tool:"LMS",                  status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k13", domain:"×—×‘×¨×ª×™ ×¨×’×©×™", metric:"×™×¨×™×“×” ×‘× ×©×™×¨×”",               target:"20%-",                   tool:"×“×™×•×•×—×™ ××—× ×›×™×",       status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k14", domain:"×¤×“×’×•×’×™",     metric:"×”×¢×¨×›×” ×—×œ×•×¤×™×ª",               target:"80% ×™×•×× ×™ ×œ××™×“×”",       tool:"×¨×¤×œ×§×¦×™×”",             status:"×‘×ª×›× ×•×Ÿ", note:""},
  {id:"k15", domain:"×˜×›× ×•×œ×•×’×™",   metric:"×¡×“× ××•×ª ×˜×›× ×•×œ×•×’×™×•×ª ×¤×¢×™×œ×•×ª",   target:"×¤×¢×™×œ×•×ª ×©×‘×•×¢×™×ª",         tool:"×™×•×× ×™ ×¡×“× ×”",          status:"×‘×ª×›× ×•×Ÿ", note:""}
];

/* ====== ××¦×‘ ×•×©××™×¨×” ====== */
let tasks = JSON.parse(localStorage.getItem('tasks_v3')) || structuredClone(defaultTasks);
let kpis  = JSON.parse(localStorage.getItem('kpis_v3'))  || structuredClone(defaultKpis);
let activeDomains = new Set(DOMAINS);
let currentView = 'Month';
let timelineChart;

function save(){ localStorage.setItem('tasks_v3', JSON.stringify(tasks)); localStorage.setItem('kpis_v3', JSON.stringify(kpis)); }

/* ====== ×”×ª×—×‘×¨×•×ª ====== */
byId('loginBtn').onclick = ()=>{
  const user = byId('u').value.trim();
  const pass = byId('p').value;
  if(user==='AliDall' && pass==='Ali@0546'){
    byId('loginOverlay').style.display='none';
    renderChips();
    google.charts.setOnLoadCallback(drawAll);
  }else{
    byId('loginMsg').textContent='×¤×¨×˜×™ ×’×™×©×” ×©×’×•×™×™×';
  }
};
['u','p'].forEach(id=>byId(id).addEventListener('keyup',e=>{ if(e.key==='Enter') byId('loginBtn').click(); }));

/* ====== ×¡×™× ×•×Ÿ ====== */
function renderChips(){
  const wrap = byId('domainChips'); wrap.innerHTML='';
  DOMAINS.forEach(dom=>{
    const el=document.createElement('span');
    el.className='chip'+(activeDomains.has(dom)?' active':'');
    el.textContent=dom;
    el.onclick=()=>{ activeDomains.has(dom)?activeDomains.delete(dom):activeDomains.add(dom); drawAll(); };
    wrap.appendChild(el);
  });
}
byId('statusFilter').onchange = ()=>drawAll();
byId('fromDate').onchange = ()=>drawAll();
byId('toDate').onchange   = ()=>drawAll();
byId('searchTxt').oninput = ()=>drawAll();
byId('clearFilters').onclick = ()=>{
  activeDomains = new Set(DOMAINS);
  byId('statusFilter').value='all';
  byId('fromDate').value='';
  byId('toDate').value='';
  byId('searchTxt').value='';
  drawAll();
};

function filteredTasks(){
  const st = byId('statusFilter').value;
  const q  = byId('searchTxt').value.trim();
  const from = byId('fromDate').value ? new Date(byId('fromDate').value) : null;
  const to   = byId('toDate').value ? new Date(byId('toDate').value) : null;

  return tasks.filter(t=>{
    if(!activeDomains.has(t.domain)) return false;
    if(st!=='all' && t.status!==st) return false;
    if(q && !t.action.includes(q)) return false;
    if(from && new Date(t.start) < from) return false;
    if(to && new Date(t.end) > to) return false;
    return true;
  });
}

/* ====== ×’×× ×˜ (Google Timeline) ====== */
function drawGantt(){
  const container = byId('gantt');
  container.innerHTML='';
  const data = filteredTasks();
  if(!data.length){ container.innerHTML='<div style="padding:16px;color:#666">××™×Ÿ × ×ª×•× ×™× ×œ×ª×¦×•×’×”</div>'; return; }

  const dt = new google.visualization.DataTable();
  dt.addColumn({type:'string', id:'Domain'});
  dt.addColumn({type:'string', id:'Action'});
  dt.addColumn({type:'date',   id:'Start'});
  dt.addColumn({type:'date',   id:'End'});
  dt.addColumn({type:'string', role:'style'});

  data.forEach(t=>{
    const style = `color: ${COLORS[t.domain]||'#0b63b6'}`;
    dt.addRow([t.domain, t.action, new Date(t.start), new Date(t.end), style]);
  });

  const opts = {
    timeline:{groupByRowLabel:true, colorByRowLabel:false, barLabelStyle:{fontSize:12}},
    hAxis:{format: currentView==='Day'?'d.M.yyyy': currentView==='Week'?'d.M':'MMM yyyy'}
  };

  timelineChart = new google.visualization.Timeline(container);
  timelineChart.draw(dt, opts);
}
window.onresize = ()=>{ if(timelineChart) drawGantt(); };

/* ====== ×˜×‘×œ×ª ××©×™××•×ª ====== */
function drawTasksTable(){
  const tb = byId('taskTable').querySelector('tbody');
  tb.innerHTML='';
  filteredTasks().forEach((t,i)=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${i+1}</td>
        <td>${t.domain}</td>
        <td>${t.action}</td>
        <td>${t.start}</td>
        <td>${t.end}</td>
        <td>
          <select onchange="updateTaskStatus('${t.id}',this.value)">
            <option ${t.status==='×‘×ª×›× ×•×Ÿ'?'selected':''}>×‘×ª×›× ×•×Ÿ</option>
            <option ${t.status==='×‘×ª×”×œ×™×š'?'selected':''}>×‘×ª×”×œ×™×š</option>
            <option ${t.status==='×”×•×©×œ×'?'selected':''}>×”×•×©×œ×</option>
            <option ${t.status==='× ×“×—×”'?'selected':''}>× ×“×—×”</option>
          </select>
        </td>
        <td>${t.dependencies||''}</td>
        <td class="actions">
          <button class="btn" onclick="openTask('${t.id}')">âœï¸ ×¢×¨×™×›×”</button>
          <button class="btn danger" onclick="removeTask('${t.id}')">ğŸ—‘ï¸ ××—×™×§×”</button>
        </td>
      </tr>
    `);
  });
}

/* ====== ×˜×‘×œ×ª KPI ====== */
function drawKpiTable(){
  const tb = byId('kpiTable').querySelector('tbody');
  tb.innerHTML='';
  kpis.forEach((k,i)=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${i+1}</td>
        <td>${k.domain}</td>
        <td>${k.metric}</td>
        <td>${k.target}</td>
        <td>${k.tool}</td>
        <td>
          <select onchange="updateKpiStatus('${k.id}',this.value)">
            <option ${k.status==='×‘×ª×›× ×•×Ÿ'?'selected':''}>×‘×ª×›× ×•×Ÿ</option>
            <option ${k.status==='×‘×ª×”×œ×™×š'?'selected':''}>×‘×ª×”×œ×™×š</option>
            <option ${k.status==='×”×•×©×œ×'?'selected':''}>×”×•×©×œ×</option>
          </select>
        </td>
        <td class="actions">
          <button class="btn" onclick="openKpi('${k.id}')">âœï¸ ×¢×¨×™×›×”</button>
          <button class="btn danger" onclick="removeKpi('${k.id}')">ğŸ—‘ï¸ ××—×™×§×”</button>
        </td>
      </tr>
    `);
  });
}

/* ====== CRUD ××©×™××•×ª â€“ ××•×“××œ ====== */
byId('addTaskBtn').onclick = ()=>{
  const dlg = byId('taskDlg');
  byId('tId').value='(×—×“×©)';
  byId('tName').value='×¤×¢×™×œ×•×ª ×—×“×©×”';
  byId('tDomain').value='×œ×™××•×“×™';
  byId('tStart').value='2025-09-15';
  byId('tEnd').value='2025-09-20';
  byId('tStatus').value='×‘×ª×›× ×•×Ÿ';
  byId('tProg').value=0;
  byId('tDep').value='';
  byId('tNote').value='';
  byId('tDelete').style.visibility='hidden';
  dlg.showModal();
  byId('tSave').onclick = (e)=>{ e.preventDefault(); saveTaskForm(null); };
};

function openTask(id){
  const t = tasks.find(x=>x.id===id);
  const dlg = byId('taskDlg');
  byId('tId').value=t.id;
  byId('tName').value=t.action;
  byId('tDomain').value=t.domain;
  byId('tStart').value=t.start;
  byId('tEnd').value=t.end;
  byId('tStatus').value=t.status;
  byId('tProg').value=t.progress||0;
  byId('tDep').value=t.dependencies||'';
  byId('tNote').value=t.note||'';
  byId('tDelete').style.visibility='visible';
  dlg.showModal();
  byId('tSave').onclick = (e)=>{ e.preventDefault(); saveTaskForm(t.id); };
  byId('tDelete').onclick = ()=>{ removeTask(id); dlg.close(); };
}

function saveTaskForm(existingId){
  let start = clampToSchoolYear(byId('tStart').value);
  let end   = clampToSchoolYear(byId('tEnd').value);
  if(new Date(start)>new Date(end)){ alert('×ª××¨×™×š ×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™/×©×•×•×” ×œ×¡×™×•×'); return; }
  if(!withinSchoolYear(start)||!withinSchoolYear(end)){ alert('×©× ×ª ×”×œ×™××•×“×™×: 01.09.2025â€“31.08.2026'); return; }
  const obj = {
    id: existingId || newId(),
    domain: byId('tDomain').value,
    action: byId('tName').value.trim(),
    start, end,
    status: byId('tStatus').value,
    dependencies: byId('tDep').value.trim(),
    progress: Math.max(0,Math.min(100, Number(byId('tProg').value||0))),
    note: byId('tNote').value.trim()
  };
  if(existingId){ tasks = tasks.map(t=>t.id===existingId?obj:t); }
  else{ tasks.push(obj); }
  save(); byId('taskDlg').close(); drawAll();
}

function removeTask(id){
  if(!confirm('×œ××—×•×§ ××ª ×”×¤×¢×™×œ×•×ª?')) return;
  tasks = tasks.filter(t=>t.id!==id);
  save(); drawAll();
}
function updateTaskStatus(id,val){
  tasks = tasks.map(t=>t.id===id?{...t,status:val}:t);
  save(); drawGantt(); drawTasksTable();
}

/* ====== CRUD KPI â€“ ××•×“××œ ====== */
byId('addKpiBtn').onclick = ()=>{
  const dlg = byId('kpiDlg');
  byId('kId').value='(×—×“×©)';
  byId('kDomain').value='×œ×™××•×“×™';
  byId('kMetric').value='××“×“ ×—×“×©';
  byId('kTarget').value='×™×¢×“ ×—×“×©';
  byId('kTool').value='×›×œ×™ ××“×™×“×”';
  byId('kStatus').value='×‘×ª×›× ×•×Ÿ';
  byId('kNote').value='';
  byId('kDelete').style.visibility='hidden';
  dlg.showModal();
  byId('kSave').onclick=(e)=>{e.preventDefault(); saveKpiForm(null);};
};

function openKpi(id){
  const k = kpis.find(x=>x.id===id);
  const dlg = byId('kpiDlg');
  byId('kId').value=k.id;
  byId('kDomain').value=k.domain;
  byId('kMetric').value=k.metric;
  byId('kTarget').value=k.target;
  byId('kTool').value=k.tool;
  byId('kStatus').value=k.status;
  byId('kNote').value=k.note||'';
  byId('kDelete').style.visibility='visible';
  dlg.showModal();
  byId('kSave').onclick=(e)=>{e.preventDefault(); saveKpiForm(k.id);};
  byId('kDelete').onclick=()=>{ removeKpi(id); dlg.close(); };
}

function saveKpiForm(existingId){
  const obj = {
    id: existingId || newId(),
    domain: byId('kDomain').value,
    metric: byId('kMetric').value.trim(),
    target: byId('kTarget').value.trim(),
    tool: byId('kTool').value.trim(),
    status: byId('kStatus').value,
    note: byId('kNote').value.trim()
  };
  if(existingId){ kpis = kpis.map(k=>k.id===existingId?obj:k); }
  else{ kpis.push(obj); }
  save(); byId('kpiDlg').close(); drawKpiTable();
}

function removeKpi(id){
  if(!confirm('×œ××—×•×§ ××ª ×”-KPI?')) return;
  kpis = kpis.filter(k=>k.id!==id);
  save(); drawKpiTable();
}
function updateKpiStatus(id,val){
  kpis = kpis.map(k=>k.id===id?{...k,status:val}:k);
  save();
}

/* ====== ×”×“×¤×¡×” ====== */
byId('printBtn').onclick = ()=>{
  const incG = byId('printGantt').checked;
  const incT = byId('printTasks').checked;
  const incK = byId('printKpi').checked;
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>×”×“×¤×¡×”</title>
  <style>body{font-family:Arial} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px;text-align:center} th{background:#eee}</style></head><body>`;
  if(incG) html += byId('ganttWrap').outerHTML;
  if(incT) html += byId('taskTable').outerHTML;
  if(incK) html += byId('kpiTable').outerHTML;
  html+='</body></html>';
  const w=window.open('','print');
  w.document.write(html); w.document.close(); w.focus(); w.print(); w.close();
};

/* ====== ×™×™×¦×•×/×™×™×‘×•×/××™×¤×•×¡ ====== */
byId('exportXlsxBtn').onclick = ()=>{
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tasks), '××©×™××•×ª');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kpis),  'KPI');
  XLSX.writeFile(wb, 'school_plan.xlsx');
};
byId('exportJsonBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify({tasks,kpis},null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='school_plan.json'; a.click();
};
byId('importJson').onchange = (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const fr = new FileReader();
  fr.onload = () =>{
    try{
      const obj = JSON.parse(fr.result);
      if(Array.isArray(obj.tasks)&&Array.isArray(obj.kpis)){
        tasks=obj.tasks; kpis=obj.kpis; save(); drawAll();
      }else alert('×§×•×‘×¥ JSON ×œ× ×ª×§×™×Ÿ');
    }catch(err){ alert('×©×’×™××” ×‘×§×¨×™××ª JSON'); }
  };
  fr.readAsText(file);
};
byId('resetBtn').onclick = ()=>{
  if(!confirm('×œ××¤×¡ ×œ× ×ª×•× ×™ ×‘×¨×™×¨×ª ××—×“×œ?')) return;
  tasks = structuredClone(defaultTasks);
  kpis  = structuredClone(defaultKpis);
  save(); drawAll();
};

/* ====== ×ª×¦×•×’×” â€“ ×™×•×/×©×‘×•×¢/×—×•×“×© ====== */
byId('viewDay').onclick  = ()=>{ currentView='Day';  drawGantt(); };
byId('viewWeek').onclick = ()=>{ currentView='Week'; drawGantt(); };
byId('viewMonth').onclick= ()=>{ currentView='Month';drawGantt(); };

/* ====== ×¨×¢× ×•×Ÿ ×›×•×œ×œ ====== */
function drawAll(){
  drawGantt();
  drawTasksTable();
  drawKpiTable();
}

/* ×¨×™× ×“×•×¨ ×™×—×œ ××—×¨×™ ×”×ª×—×‘×¨×•×ª */
google.charts.setOnLoadCallback(()=>{ /* × ×˜×¢×Ÿ, × ×¦×™×™×¨ ××—×¨×™ login */ });
</script>
</body>
</html>


